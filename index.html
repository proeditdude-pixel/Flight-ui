<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IFE_V7_SMART_SEAT</title>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  /* --- THEME VARIABLES --- */
  :root {
    --pry: #0078d4;
    --bg-img: url('https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?q=80&w=2068&auto=format&fit=crop');
    --glass: rgba(0, 0, 0, 0.65);
    --border: 1px solid rgba(255, 255, 255, 0.15);
    --txt: #ffffff;
  }

  body { margin: 0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; color: var(--txt); }
  
  /* Background */
  .bg-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-image: var(--bg-img); background-size: cover; background-position: center;
    z-index: -1; filter: brightness(0.4);
  }

  /* Layout */
  .app { display: flex; height: 100%; backdrop-filter: blur(8px); }

  /* Sidebar */
  .sidebar {
    width: 90px; background: rgba(0,0,0,0.85); border-right: var(--border);
    display: flex; flex-direction: column; align-items: center; padding: 25px 0; z-index: 100;
  }
  .logo { width: 50px; height: 50px; object-fit: contain; margin-bottom: 40px; }
  
  .nav-btn {
    width: 55px; height: 55px; border-radius: 15px; margin-bottom: 15px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    color: #888; cursor: pointer; transition: 0.3s;
  }
  .nav-btn:hover, .nav-btn.active { background: var(--pry); color: #fff; box-shadow: 0 0 20px var(--pry); transform: scale(1.05); }
  .nav-btn i { font-size: 20px; margin-bottom: 5px; }
  .nav-btn span { font-size: 9px; font-weight: 700; text-transform: uppercase; }

  /* Main Content */
  .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

  /* Header */
  .top-bar {
    height: 70px; border-bottom: var(--border); background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
  }
  .flight-title { font-size: 24px; font-weight: 800; letter-spacing: 1px; }
  .flight-stats { display: flex; gap: 20px; font-size: 13px; }
  .stat-pill { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; border: var(--border); display: flex; align-items: center; gap: 8px; }

  /* Content Area */
  .content-area { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
  .view { display: none; animation: slideUp 0.4s ease-out; }
  .view.active { display: block; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* Widgets */
  .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
  .widget { background: var(--glass); border: var(--border); border-radius: 15px; padding: 20px; }
  .widget h3 { margin: 0 0 10px 0; font-size: 12px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
  .big-text { font-size: 36px; font-weight: 300; }
  
  /* Map */
  .map-frame { width: 100%; height: 350px; background: #050505; border-radius: 15px; border: var(--border); position: relative; overflow: hidden; }
  .plane-marker { position: absolute; top: 48%; font-size: 32px; color: var(--pry); transition: left 1s linear; transform: rotate(90deg) translateY(-50%); text-shadow: 0 0 15px var(--pry); }

  /* Media Grid */
  .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
  .media-card { background: #000; border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.2s; border: var(--border); position: relative; }
  .media-card:hover { transform: scale(1.05); border-color: var(--pry); z-index: 10; }
  .media-card img { width: 100%; height: 260px; object-fit: cover; }
  .media-info { padding: 12px; background: #111; }

  /* Chat */
  .chat-container { display: flex; flex-direction: column; height: 500px; background: var(--glass); border-radius: 15px; border: var(--border); overflow: hidden; }
  .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
  .msg-bubble { background: rgba(255,255,255,0.1); padding: 10px 14px; border-radius: 12px; max-width: 70%; align-self: flex-start; font-size: 14px; }
  .msg-bubble.mine { background: var(--pry); align-self: flex-end; }
  .chat-input { display: flex; border-top: var(--border); background: rgba(0,0,0,0.5); }
  .chat-input input { flex: 1; background: transparent; border: none; color: #fff; padding: 20px; outline: none; font-size: 16px; }
  .chat-input button { width: 90px; background: var(--pry); border: none; color: #fff; font-weight: bold; cursor: pointer; }

  /* Admin Panel */
  .admin-panel {
    position: fixed; top: 0; right: -500px; width: 400px; height: 100%;
    background: #090909; border-left: 1px solid #333; z-index: 2000;
    transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px; box-shadow: -30px 0 60px #000; overflow-y: auto;
  }
  .admin-panel.open { right: 0; }
  
  .adm-section { background: #151515; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
  .adm-section h4 { margin: 0 0 15px 0; color: var(--pry); font-size: 14px; letter-spacing: 1px; }
  .inp-group { margin-bottom: 12px; }
  .inp-group label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
  .inp-group input, .inp-group select { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; box-sizing: border-box; }
  
  .btn-save { width: 100%; background: var(--pry); color: #fff; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; letter-spacing: 1px; }

  /* Video Modal */
  .vid-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; }
  .close-vid { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; cursor: pointer; z-index: 3001; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 50%; }
  iframe { width: 100%; height: 100%; border: none; }
</style>
</head>
<body>

<div class="bg-layer"></div>

<div class="app">
  <div class="sidebar">
    <img id="logo_img" class="logo" src="">
    <div class="nav-btn active" onclick="nav('home', this)"><i class="fas fa-home"></i><span>Home</span></div>
    <div class="nav-btn" onclick="nav('map', this)"><i class="fas fa-map-marked-alt"></i><span>Map</span></div>
    <div class="nav-btn" onclick="nav('watch', this)"><i class="fas fa-film"></i><span>Watch</span></div>
    <div class="nav-btn" onclick="nav('games', this)"><i class="fas fa-gamepad"></i><span>Play</span></div>
    <div class="nav-btn" onclick="nav('chat', this)"><i class="fas fa-comments"></i><span>Chat</span></div>
    
    <div style="margin-top:auto;"></div>
    <div class="nav-btn" onclick="toggleAdmin()" style="opacity:0.5"><i class="fas fa-cog"></i><span>Set</span></div>
  </div>

  <div class="main">
    <div class="top-bar">
      <div>
        <div class="flight-title" id="ui_fn">FLIGHT...</div>
        <div style="font-size:12px; color:#bbb;" id="ui_al">AIRLINE</div>
      </div>
      <div class="flight-stats">
        <div class="stat-pill"><i class="fas fa-chair"></i> <span id="ui_seat">Allocating...</span></div>
        <div class="stat-pill"><i class="fas fa-clock"></i> <span id="ui_rem">00:00</span></div>
      </div>
    </div>

    <div id="anno_bar" style="background:var(--pry); color:#fff; padding:12px 30px; font-size:14px; font-weight:600; display:none; animation:slideUp 0.3s;">
      <i class="fas fa-bullhorn" style="margin-right:10px;"></i> <span id="ui_msg"></span>
    </div>

    <div class="content-area">
      
      <div id="home" class="view active">
        <h2 style="margin-top:0;">Flight Dashboard</h2>
        <div class="dash-grid">
          <div class="widget">
            <h3>Route</h3>
            <div class="big-text" style="font-size:24px"><span id="ui_org">---</span> <i class="fas fa-arrow-right" style="font-size:16px; margin:0 10px; opacity:0.5"></i> <span id="ui_dst">---</span></div>
          </div>
          <div class="widget">
            <h3>Ground Speed</h3>
            <div class="big-text"><span id="ui_spd">0</span> <small style="font-size:14px">km/h</small></div>
          </div>
          <div class="widget">
            <h3>Altitude</h3>
            <div class="big-text">38,000 <small style="font-size:14px">ft</small></div>
          </div>
          <div class="widget">
            <h3>Temp</h3>
            <div class="big-text">-54 <small style="font-size:14px">&deg;C</small></div>
          </div>
        </div>
      </div>

      <div id="map" class="view">
        <h2>Live Tracker</h2>
        <div class="map-frame">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/World_map_blank_without_borders.svg/2000px-World_map_blank_without_borders.svg.png" style="width:100%; height:100%; opacity:0.4; object-fit:cover;">
          <div style="position:absolute; top:50%; left:10%; right:10%; height:1px; background:rgba(255,255,255,0.2);"></div>
          <i class="fas fa-plane plane-marker" id="plane_icon" style="left:10%"></i>
        </div>
      </div>

      <div id="watch" class="view">
        <h2>Entertainment</h2>
        <div class="media-grid" id="movie_list"></div>
      </div>

      <div id="games" class="view">
        <h2>Arcade</h2>
        <div class="media-grid" id="game_list"></div>
      </div>

      <div id="chat" class="view">
        <h2>Passenger Network</h2>
        <div class="chat-container">
          <div class="chat-msgs" id="chat_area">
            <div style="text-align:center; opacity:0.5; font-size:12px; margin-top:10px;">Connected to onboard network.</div>
          </div>
          <div class="chat-input">
            <input type="text" id="msg_in" placeholder="Type a message...">
            <button onclick="sendMsg()">SEND</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="admin-panel" id="adm_panel">
  <div style="margin-bottom:20px; overflow:hidden;">
    <h2 style="float:left; margin:0; color:#fff;">SYSTEM SETTINGS</h2>
    <button class="btn-save" style="width:auto; float:right; background:#333; margin:0; padding:8px 15px;" onclick="toggleAdmin()">CLOSE</button>
  </div>

  <div class="adm-section">
    <h4>MY PROFILE</h4>
    <div class="inp-group"><label>My Seat Number</label><input id="my_seat_in" readonly style="opacity:0.5; cursor:not-allowed"></div>
    <div style="font-size:10px; color:#666;">*Assigned automatically to prevent duplicates.</div>
  </div>

  <div class="adm-section">
    <h4>VISUALS (GLOBAL)</h4>
    <div class="inp-group"><label>Theme Color (Hex)</label><input id="s_color"></div>
    <div class="inp-group"><label>Background Image URL</label><input id="s_bg"></div>
    <button class="btn-save" onclick="saveVisuals()">APPLY VISUALS</button>
  </div>

  <div class="adm-section">
    <h4>FLIGHT DATA (GLOBAL)</h4>
    <div class="inp-group"><label>Airline Name</label><input id="s_al"></div>
    <div class="inp-group"><label>Flight Number</label><input id="s_fn"></div>
    <div class="inp-group"><label>Origin Code</label><input id="s_og"></div>
    <div class="inp-group"><label>Dest Code</label><input id="s_ds"></div>
    <div class="inp-group"><label>Logo URL</label><input id="s_lg"></div>
    <button class="btn-save" onclick="saveFlightInfo()">UPDATE INFO</button>
  </div>

  <div class="adm-section">
    <h4>LIVE STATUS</h4>
    <div class="inp-group"><label>Progress (%)</label><input type="range" id="s_pr" min="0" max="100" oninput="liveUpdate(this.value)"></div>
    <div class="inp-group"><label>Speed (km/h)</label><input id="s_sp"></div>
    <div class="inp-group"><label>Time Remaining</label><input id="s_rm"></div>
    <button class="btn-save" onclick="saveStatus()">UPDATE STATUS</button>
  </div>

  <div class="adm-section">
    <h4>ANNOUNCEMENT</h4>
    <div class="inp-group"><label>Message</label><input id="s_msg"></div>
    <div style="display:flex; gap:10px;">
        <button class="btn-save" onclick="saveMsg()">BROADCAST</button>
        <button class="btn-save" style="background:#555;" onclick="clearMsg()">CLEAR</button>
    </div>
  </div>
</div>

<div class="vid-overlay" id="vid_modal">
  <div class="close-vid" onclick="closeVid()">&times;</div>
  <iframe id="vid_frame" allow="autoplay; fullscreen"></iframe>
</div>

<script>
// --- CONFIGURATION ---
const C = { apiKey: "AIzaSyBiabDx61thAOm_A-_2x_mC9Nb9gArRCns", authDomain: "flight-ui.firebaseapp.com", projectId: "flight-ui", appId: "1:507585547506:web:a2f401ddda5055b59ed46b" };

const MOVIES = [
  {t:"Top Gun: Maverick", i:"https://upload.wikimedia.org/wikipedia/en/1/13/Top_Gun_Maverick_Poster.jpg", u:"https://www.youtube.com/embed/qSqVVzvW13s?autoplay=1"},
  {t:"Interstellar", i:"https://upload.wikimedia.org/wikipedia/en/b/bc/Interstellar_film_poster.jpg", u:"https://www.youtube.com/embed/zSWdZVtXT7E?autoplay=1"},
  {t:"Avatar 2", i:"https://upload.wikimedia.org/wikipedia/en/5/54/Avatar_The_Way_of_Water_poster.jpg", u:"https://www.youtube.com/embed/d9MyqF3bPhI?autoplay=1"},
  {t:"Spider-Man", i:"https://upload.wikimedia.org/wikipedia/en/2/21/Web_of_Spider-Man_Vol_1_129-1.png", u:"https://www.youtube.com/embed/JfVOs4VSpmA?autoplay=1"}
];
const GAMES = [
  {t:"Minecraft", i:"https://upload.wikimedia.org/wikipedia/en/5/51/Minecraft_cover.png", u:"https://classic.minecraft.net/"},
  {t:"Space Invaders", i:"https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Space_Invaders_Arcade.png/220px-Space_Invaders_Arcade.png", u:"https://freeinvaders.org/"}
];

let db, ref, chatRef, presenceRef;
let mySeat = "";

function init() {
  try {
    firebase.initializeApp(C);
    db = firebase.database();
    ref = db.ref('v7_flight');
    chatRef = db.ref('v7_chat');
    presenceRef = db.ref('v7_presence');

    setupSeat();
    renderMedia();
    listen();
  } catch(e) { console.log(e); }
}

// --- INTELLIGENT SEAT LOGIC ---
function setupSeat() {
  // Check if we already have a session seat (in case of refresh)
  let saved = localStorage.getItem("v7_seat_id");
  if(saved) {
    checkAndClaim(saved);
  } else {
    generateAndClaim();
  }
}

function generateAndClaim() {
  // Gen random seat: 1-60 + A-F
  let r = Math.floor(Math.random() * 60) + 1;
  let l = ["A","B","C","D","E","F"][Math.floor(Math.random()*6)];
  let candidate = "Seat " + r + l;
  checkAndClaim(candidate);
}

function checkAndClaim(seat) {
  // Check DB to see if this seat is taken by an ONLINE user
  presenceRef.child(seat).once('value', snap => {
    if(snap.exists()) {
       // Seat is taken! Try another one.
       console.log("Collision on " + seat + ". Retrying...");
       generateAndClaim(); 
    } else {
      // Seat is free! Claim it.
      mySeat = seat;
      localStorage.setItem("v7_seat_id", seat);
      
      // UI Update
      document.getElementById('ui_seat').innerText = seat;
      document.getElementById('my_seat_in').value = seat;

      // DATABASE CLAIM (The Magic Part)
      // We set a value, and tell Firebase: "If I disconnect, delete this."
      let myRef = presenceRef.child(seat);
      myRef.set({ status: 'online', time: Date.now() });
      myRef.onDisconnect().remove(); 
    }
  });
}

// --- LISTENERS ---
function listen() {
  ref.child('info').on('value', s => {
    const v = s.val(); if(!v) return;
    document.getElementById('ui_fn').innerText = v.fn || "FLIGHT";
    document.getElementById('ui_al').innerText = v.al || "AIRLINE";
    document.getElementById('ui_org').innerText = v.og;
    document.getElementById('ui_dst').innerText = v.ds;
    document.getElementById('logo_img').src = v.lg;
    
    // Set Theme
    if(v.col) document.documentElement.style.setProperty('--pry', v.col);
    if(v.bg) document.documentElement.style.setProperty('--bg-img', `url('${v.bg}')`);
    
    // Sync Admin
    document.getElementById('s_fn').value = v.fn;
    document.getElementById('s_al').value = v.al;
    document.getElementById('s_og').value = v.og;
    document.getElementById('s_ds').value = v.ds;
    document.getElementById('s_lg').value = v.lg;
    document.getElementById('s_color').value = v.col;
    document.getElementById('s_bg').value = v.bg;
  });

  ref.child('status').on('value', s => {
    const v = s.val(); if(!v) return;
    document.getElementById('ui_spd').innerText = v.sp;
    document.getElementById('ui_rem').innerText = v.rm;
    let pct = v.pr || 0;
    document.getElementById('plane_icon').style.left = (10 + pct*0.8) + "%";
    
    document.getElementById('s_pr').value = pct;
    document.getElementById('s_sp').value = v.sp;
    document.getElementById('s_rm').value = v.rm;
  });

  ref.child('msg').on('value', s => {
    const txt = s.val();
    const bar = document.getElementById('anno_bar');
    if(txt) {
      bar.style.display = "block";
      document.getElementById('ui_msg').innerText = txt;
    } else {
      bar.style.display = "none";
    }
    document.getElementById('s_msg').value = txt || "";
  });

  chatRef.limitToLast(30).on('child_added', s => {
    const v = s.val();
    const area = document.getElementById('chat_area');
    const isMe = v.u === mySeat;
    area.innerHTML += `<div class="msg-bubble ${isMe?'mine':''}"><b style="font-size:10px; opacity:0.7">${v.u}</b><br>${v.m}</div>`;
    area.scrollTop = area.scrollHeight;
  });
}

// --- ACTIONS ---
function saveFlightInfo() {
  ref.child('info').update({
    fn: document.getElementById('s_fn').value,
    al: document.getElementById('s_al').value,
    og: document.getElementById('s_og').value,
    ds: document.getElementById('s_ds').value,
    lg: document.getElementById('s_lg').value
  });
}
function saveVisuals() {
  ref.child('info').update({
    col: document.getElementById('s_color').value,
    bg: document.getElementById('s_bg').value
  });
}
function saveStatus() {
  ref.child('status').update({
    sp: document.getElementById('s_sp').value,
    rm: document.getElementById('s_rm').value,
    pr: document.getElementById('s_pr').value
  });
}
function liveUpdate(v){ ref.child('status').update({pr: v}); }
function saveMsg(){ ref.child('msg').set(document.getElementById('s_msg').value); }
function clearMsg(){ ref.child('msg').remove(); }

function sendMsg() {
  const i = document.getElementById('msg_in');
  if(!i.value || !mySeat) return;
  chatRef.push({ u: mySeat, m: i.value });
  i.value = "";
}

function nav(id, el) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if(el) el.classList.add('active');
}
function toggleAdmin(){ document.getElementById('adm_panel').classList.toggle('open'); }
function renderMedia() {
  document.getElementById('movie_list').innerHTML = MOVIES.map(m=>`<div class="media-card" onclick="play('${m.u}')"><img src="${m.i}"><div class="media-info">${m.t}</div></div>`).join('');
  document.getElementById('game_list').innerHTML = GAMES.map(g=>`<div class="media-card" onclick="play('${g.u}')"><img src="${g.i}"><div class="media-info">${g.t}</div></div>`).join('');
}
function play(u){ document.getElementById('vid_modal').style.display='block'; document.getElementById('vid_frame').src=u; }
function closeVid(){ document.getElementById('vid_modal').style.display='none'; document.getElementById('vid_frame').src=""; }

window.onload = init;
</script>
</body>
</html>
