<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CX_IFE_V30_OMNIBUS</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800&family=Oswald:wght@200;300;400;500;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBiabDx61thAOm_A-_2x_mC9Nb9gArRCns",
        authDomain: "flight-ui.firebaseapp.com",
        databaseURL: "https://flight-ui-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "flight-ui",
        storageBucket: "flight-ui.firebasestorage.app",
        messagingSenderId: "507585547506",
        appId: "1:507585547506:web:a2f401ddda5055b59ed46b",
        measurementId: "G-894GEVXT4V"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    console.log(">> FIREBASE V30 ONLINE");
    window.FB_APP = app;
</script>

<style>
/* ==========================================================================
   1. CORE VARIABLES 
   ========================================================================== 
*/
:root {
    /* DARK MODE PALETTE */
    --bg-deep: #000000;
    --bg-main: #0a0a0a;
    --bg-card: #141414;
    --bg-card-hover: #1f1f1f;
    --bg-input: #050505;
    
    /* ACCENTS */
    --acc-teal: #006B6E;
    --acc-teal-glow: rgba(0, 107, 110, 0.5);
    --acc-gold: #C3A676;
    --acc-gold-dim: #8a734e;
    --acc-red: #d63031;
    
    /* TEXT */
    --txt-white: #ffffff;
    --txt-grey: #a0a0a0;
    --txt-dim: #555555;
    
    /* LAYOUT */
    --sb-width: 100px;
    --hd-height: 80px;
    --pad-page: 40px;
    
    /* BORDERS & EFFECTS */
    --border: 1px solid rgba(255,255,255,0.08);
    --shadow: 0 10px 30px rgba(0,0,0,0.5);
    --glass: blur(10px);
}

/* ==========================================================================
   2. RESET & BASE 
   ========================================================================== 
*/
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    background: var(--bg-deep);
    color: var(--txt-white);
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    display: flex;
}
::-webkit-scrollbar { width: 0; display: none; }

/* UTILITY FONTS */
.font-head { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
.font-mono { font-family: 'Space Mono', monospace; }
.text-teal { color: var(--acc-teal); }
.text-gold { color: var(--acc-gold); }

/* ==========================================================================
   3. SYSTEM LAYERS (BOOT, LOCK, VIEWER)
   ========================================================================== 
*/
#sys-boot {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 9000;
    display: flex; align-items: center; justify-content: center;
    flex-direction: column;
}
.boot-txt { font-family: 'Space Mono'; color: var(--acc-teal); font-size: 12px; margin-top: 10px; }

#sys-lock {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 5000;
    transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex; align-items: center; justify-content: center;
}
.lock-cont {
    text-align: center;
    background: rgba(20,20,20,0.8);
    backdrop-filter: blur(20px);
    padding: 60px;
    border: var(--border);
    border-radius: 20px;
    width: 500px;
}
.lock-logo { width: 120px; height: auto; margin-bottom: 20px; }
.btn-unlock {
    background: transparent; border: 1px solid rgba(255,255,255,0.3);
    color: #fff; padding: 15px 40px; font-family: 'Space Mono';
    text-transform: uppercase; cursor: pointer; margin-top: 30px;
    transition: 0.3s;
}
.btn-unlock:hover { background: #fff; color: #000; border-color: #fff; }

#sys-viewer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 6000; display: none; flex-direction: column;
}
.viewer-bar {
    height: 50px; background: #111; display: flex;
    justify-content: space-between; align-items: center; padding: 0 20px;
    border-bottom: 1px solid #333;
}
.viewer-frame { flex: 1; border: none; width: 100%; height: 100%; }

/* ==========================================================================
   4. NAVIGATION SIDEBAR
   ========================================================================== 
*/
.sidebar {
    width: var(--sb-width); height: 100%;
    background: #080808; border-right: var(--border);
    display: flex; flex-direction: column; z-index: 100;
}
.sb-logo-box {
    height: 100px; display: flex; justify-content: center; align-items: center;
    background: linear-gradient(to bottom, rgba(0,107,110,0.1), transparent);
}
.sb-logo { width: 40px; height: 40px; object-fit: contain; }

.nav-btn {
    height: 90px; display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    color: var(--txt-grey); cursor: pointer; transition: 0.3s;
    border-left: 3px solid transparent;
}
.nav-btn i { font-size: 20px; margin-bottom: 8px; }
.nav-btn span { font-size: 9px; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }
.nav-btn:hover { color: #fff; background: rgba(255,255,255,0.03); }
.nav-btn.active {
    color: var(--acc-teal); border-left: 3px solid var(--acc-teal);
    background: linear-gradient(90deg, rgba(0,107,110,0.1), transparent);
}

/* ==========================================================================
   5. MAIN STAGE & HEADER
   ========================================================================== 
*/
.stage { flex: 1; position: relative; display: flex; flex-direction: column; }

/* BACKGROUNDS */
.bg-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center; opacity: 0.3;
    z-index: 0; transition: background-image 0.5s;
}
.bg-vignette {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, transparent 0%, #000 120%);
    z-index: 1; pointer-events: none;
}

/* HEADER */
.header {
    height: var(--hd-height); padding: 0 40px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: var(--border); background: rgba(10,10,10,0.5);
    backdrop-filter: blur(10px); position: relative; z-index: 10;
}
.flight-track { display: flex; align-items: center; gap: 20px; }
.ft-code { font-family: 'Oswald'; font-size: 32px; }
.ft-icon { color: var(--acc-gold); transform: rotate(90deg); font-size: 18px; }
.user-info { display: flex; align-items: center; gap: 30px; }
.seat-badge {
    border: 1px solid var(--acc-gold); color: var(--acc-gold);
    padding: 5px 12px; font-family: 'Oswald'; border-radius: 4px; font-size: 18px;
}

/* ==========================================================================
   6. PAGE CONTAINERS
   ========================================================================== 
*/
.content-area { flex: 1; position: relative; overflow: hidden; z-index: 10; }

.page {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    padding: var(--pad-page); overflow-y: auto;
    opacity: 0; transform: translateY(20px); pointer-events: none;
    transition: all 0.4s ease;
}
.page.active { opacity: 1; transform: translateY(0); pointer-events: all; }

/* ==========================================================================
   7. ENT (ENTERTAINMENT) TABS & CARDS
   ========================================================================== 
*/
.ent-nav { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0px; }
.ent-tab {
    padding: 10px 20px; cursor: pointer; color: var(--txt-grey);
    font-family: 'Oswald'; text-transform: uppercase; letter-spacing: 1px;
    border-bottom: 2px solid transparent; transition: 0.3s;
}
.ent-tab:hover { color: #fff; }
.ent-tab.active { color: var(--acc-teal); border-bottom: 2px solid var(--acc-teal); }

.media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; padding-bottom: 100px; display: none; }
.media-grid.show { display: grid; animation: fadeIn 0.5s; }

.card-media {
    background: var(--bg-card); border: var(--border);
    border-radius: 8px; overflow: hidden; cursor: pointer;
    transition: 0.3s; position: relative; aspect-ratio: 2/3;
}
.card-media:hover { transform: translateY(-5px); border-color: var(--acc-teal); box-shadow: var(--shadow); }
.cm-img { width: 100%; height: 100%; object-fit: cover; }
.cm-over {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, #000, transparent);
    padding: 15px;
}
.cm-tag {
    position: absolute; top: 10px; right: 10px;
    background: var(--acc-teal); color: #fff;
    padding: 3px 8px; font-size: 9px; border-radius: 3px;
    font-weight: bold; text-transform: uppercase;
}

/* ==========================================================================
   8. CHAT INTERFACE
   ========================================================================== 
*/
.chat-layout {
    display: flex; flex-direction: column; height: 100%;
    background: #111; border: var(--border); border-radius: 8px; overflow: hidden;
}
.chat-history {
    flex: 1; padding: 20px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 15px;
}
.chat-bubble {
    max-width: 70%; padding: 12px 16px; border-radius: 12px;
    font-size: 13px; line-height: 1.5; position: relative;
}
.cb-in { background: #222; align-self: flex-start; border-bottom-left-radius: 2px; }
.cb-out { background: var(--acc-teal-glow); align-self: flex-end; border-bottom-right-radius: 2px; }
.cb-meta { display: block; font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 4px; }

.chat-controls {
    height: 70px; background: #080808; border-top: var(--border);
    display: flex; padding: 15px; gap: 15px;
}
.chat-input {
    flex: 1; background: #1a1a1a; border: 1px solid #333;
    color: #fff; padding: 0 15px; border-radius: 4px; font-family: 'Inter';
}
.chat-send {
    width: 100px; background: var(--acc-teal); color: #fff;
    border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
}

/* ==========================================================================
   9. SETTINGS FORMS & INPUTS
   ========================================================================== 
*/
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
.set-panel { background: #111; border: var(--border); padding: 25px; border-radius: 8px; }
.set-head {
    font-family: 'Oswald'; font-size: 18px; color: var(--acc-teal);
    border-bottom: 1px solid #222; padding-bottom: 15px; margin-bottom: 20px;
}
.inp-row { margin-bottom: 15px; }
.inp-lbl { display: block; font-size: 10px; color: var(--txt-grey); margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
.inp-field {
    width: 100%; padding: 10px; background: var(--bg-input);
    border: 1px solid #333; color: #fff; border-radius: 4px;
}
.inp-field:focus { border-color: var(--acc-teal); }
.btn-action {
    width: 100%; padding: 12px; margin-top: 10px; background: var(--acc-teal);
    color: #fff; border: none; font-weight: bold; text-transform: uppercase;
    cursor: pointer; border-radius: 4px; transition: 0.2s;
}
.btn-action:hover { background: #fff; color: #000; }
.btn-danger { background: #631818; }

/* ==========================================================================
   10. KEYFRAMES
   ========================================================================== 
*/
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

</style>
</head>
<body>

<div id="sys-boot">
    <i class="fas fa-plane-departure" style="font-size: 40px; color: #fff;"></i>
    <div class="boot-txt">CX_IFE_V30 LOADED</div>
</div>

<div id="sys-lock">
    <div class="bg-layer" style="background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2000'); z-index:-1;"></div>
    <div class="lock-cont">
        <img id="lock-logo" src="" class="lock-logo">
        <h1 class="font-head" style="font-size: 40px;">Welcome Aboard</h1>
        <p style="color: var(--acc-gold); font-family: 'Space Mono'; text-transform: uppercase; font-size: 12px; margin-bottom: 30px;">
            First Class Suite • Seat <span id="lock-seat">1A</span>
        </p>
        <button class="btn-unlock" onclick="SYS.unlock()">Access System</button>
    </div>
</div>

<div id="sys-viewer">
    <div class="viewer-bar">
        <span class="font-mono text-teal">MEDIA PLAYBACK</span>
        <i class="fas fa-times" style="font-size: 24px; cursor: pointer; color: #fff;" onclick="PLAYER.close()"></i>
    </div>
    <iframe id="viewer-frame" class="viewer-frame" allowfullscreen allow="autoplay; gamepad"></iframe>
</div>

<div class="sidebar">
    <div class="sb-logo-box">
        <img id="sb-logo" src="" class="sb-logo">
    </div>
    
    <div class="nav-btn active" onclick="NAV.go('p-home', this)">
        <i class="fas fa-home"></i><span>Home</span>
    </div>
    <div class="nav-btn" onclick="NAV.go('p-ent', this)">
        <i class="fas fa-photo-video"></i><span>Ent</span>
    </div>
    <div class="nav-btn" onclick="NAV.go('p-map', this)">
        <i class="fas fa-globe-asia"></i><span>Flight</span>
    </div>
    <div class="nav-btn" onclick="NAV.go('p-shop', this)">
        <i class="fas fa-shopping-bag"></i><span>Shop</span>
    </div>
    <div class="nav-btn" onclick="NAV.go('p-chat', this)">
        <i class="fas fa-comments"></i><span>Chat</span>
    </div>
    <div style="flex:1;"></div>
    <div class="nav-btn" onclick="NAV.go('p-set', this)">
        <i class="fas fa-sliders-h"></i><span>Settings</span>
    </div>
</div>

<div class="stage">
    <div class="bg-vignette"></div>
    <div id="main-bg" class="bg-layer"></div>

    <div class="header">
        <div class="flight-track">
            <span class="ft-code" id="h-org">HKG</span>
            <i class="fas fa-plane ft-icon"></i>
            <span class="ft-code" id="h-dst">LHR</span>
            <div style="margin-left: 15px; border: 1px solid #444; padding: 4px 8px; border-radius: 4px;">
                <span class="font-mono" style="font-size: 11px; color: #aaa;" id="h-flt">CX888</span>
            </div>
        </div>
        <div class="user-info">
            <span class="font-head" style="font-size: 14px;" id="sys-clock">12:00</span>
            <div class="seat-badge" id="h-seat">1A</div>
        </div>
    </div>

    <div class="content-area">

        <div id="p-home" class="page active">
            <h1 class="font-head" style="font-size: 48px;">Hello, <span class="text-teal" id="u-name">Guest</span></h1>
            <p class="font-mono" style="color: var(--acc-gold);">SYSTEM STATUS: NORMAL</p>
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 40px; height: 400px;">
                <div style="background: #000; border: var(--border); position: relative;">
                    <canvas id="mini-map" style="width: 100%; height: 100%;"></canvas>
                    <div style="position: absolute; bottom: 20px; left: 20px; font-family: 'Space Mono'; font-size: 12px; background: rgba(0,0,0,0.7); padding: 10px;">
                        ALT: 38,000 FT <br> SPD: 590 MPH
                    </div>
                </div>
                <div style="background: #111; border: var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                    <i class="fas fa-cloud-moon" style="font-size: 60px; margin-bottom: 20px;"></i>
                    <div class="font-head" style="font-size: 40px;">14°C</div>
                    <div class="font-mono text-gold" style="font-size: 12px; text-transform: uppercase;">Destination Temp</div>
                </div>
            </div>
        </div>

        <div id="p-ent" class="page">
            <h1 class="font-head" style="margin-bottom: 10px;">Entertainment Hub</h1>
            
            <div class="ent-nav">
                <div class="ent-tab active" onclick="ENT.tab('mov')">Movies & TV</div>
                <div class="ent-tab" onclick="ENT.tab('gam')">Arcade Games</div>
            </div>

            <div id="grid-mov" class="media-grid show">
                </div>

            <div id="grid-gam" class="media-grid">
                </div>
        </div>

        <div id="p-map" class="page">
            <div style="width: 100%; height: 100%; background: #000; position: relative; border: var(--border);">
                <canvas id="main-map" style="width: 100%; height: 100%;"></canvas>
                <div style="position: absolute; top: 30px; right: 30px; text-align: right;">
                    <div class="font-head" style="font-size: 60px; line-height: 1;">38,000</div>
                    <div class="font-mono text-gold">FEET</div>
                </div>
            </div>
        </div>

        <div id="p-shop" class="page">
            <h1 class="font-head" style="margin-bottom: 30px;">Duty Free</h1>
            <div id="grid-shop" class="media-grid show" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                </div>
        </div>

        <div id="p-chat" class="page">
            <h1 class="font-head" style="margin-bottom: 20px;">Crew Messenger</h1>
            <div class="chat-layout">
                <div class="chat-history" id="chat-box">
                    </div>
                <div class="chat-controls">
                    <input type="text" id="chat-inp" class="chat-input" placeholder="Type your request...">
                    <button class="chat-send" onclick="CHAT.send()">SEND</button>
                </div>
            </div>
        </div>

        <div id="p-set" class="page">
            <h1 class="font-head" style="margin-bottom: 30px;">System Config</h1>
            
            <div class="settings-grid">
                
                <div class="set-panel">
                    <div class="set-head">Flight Identity</div>
                    <div class="inp-row">
                        <label class="inp-lbl">Passenger Name</label>
                        <input id="set-name" class="inp-field">
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">Seat</label>
                        <input id="set-seat" class="inp-field">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                         <div class="inp-row">
                            <label class="inp-lbl">Origin</label>
                            <input id="set-org" class="inp-field" maxlength="3" style="text-transform:uppercase;">
                        </div>
                        <div class="inp-row">
                            <label class="inp-lbl">Dest</label>
                            <input id="set-dst" class="inp-field" maxlength="3" style="text-transform:uppercase;">
                        </div>
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">Flight #</label>
                        <input id="set-flt" class="inp-field" style="text-transform:uppercase;">
                    </div>
                    <button class="btn-action" onclick="CMS.saveId()">Update Identity</button>
                </div>

                <div class="set-panel">
                    <div class="set-head">Visuals</div>
                    <div class="inp-row">
                        <label class="inp-lbl">Logo URL (Raw Image)</label>
                        <input id="set-logo" class="inp-field">
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">Wallpaper URL</label>
                        <input id="set-bg" class="inp-field">
                    </div>
                    <button class="btn-action" onclick="CMS.saveVis()">Update Visuals</button>
                </div>

                <div class="set-panel">
                    <div class="set-head">Add Movie / Video</div>
                    <div class="inp-row">
                        <label class="inp-lbl">Title</label>
                        <input id="add-mov-t" class="inp-field">
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">Poster Image URL</label>
                        <input id="add-mov-i" class="inp-field">
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">YouTube Embed / MP4 URL</label>
                        <input id="add-mov-u" class="inp-field">
                    </div>
                    <button class="btn-action" onclick="CMS.addMedia()">Add to Library</button>
                </div>

                <div class="set-panel">
                    <div class="set-head">Add Game</div>
                    <div class="inp-row">
                        <label class="inp-lbl">Game Title</label>
                        <input id="add-gam-t" class="inp-field">
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">Thumbnail Image URL</label>
                        <input id="add-gam-i" class="inp-field">
                    </div>
                    <div class="inp-row">
                        <label class="inp-lbl">Game URL (HTML5)</label>
                        <input id="add-gam-u" class="inp-field">
                    </div>
                    <button class="btn-action" onclick="CMS.addGame()">Add to Arcade</button>

                    <button class="btn-action btn-danger" style="margin-top: 30px;" onclick="CMS.reset()">Factory Reset</button>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
/**
 * =============================================================================
 * CX_IFE V30 SYSTEM KERNEL
 * =============================================================================
 */

// --- 1. DEFAULT DATABASE ---
const DB_FACTORY = {
    user: { name: "Valued Guest", seat: "1A", org: "HKG", dst: "LHR", flt: "CX888" },
    vis: { 
        logo: "https://upload.wikimedia.org/wikipedia/en/thumb/9/96/Cathay_Pacific_logo.svg/1200px-Cathay_Pacific_logo.svg.png",
        bg: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2000"
    },
    movies: [
        { t: "Top Gun: Maverick", i: "https://upload.wikimedia.org/wikipedia/en/1/13/Top_Gun_Maverick_Poster.jpg", u: "https://www.youtube.com/embed/giXco2jaZ_4?autoplay=1" },
        { t: "Dune: Part Two", i: "https://upload.wikimedia.org/wikipedia/en/5/52/Dune_Part_Two_poster.jpeg", u: "https://www.youtube.com/embed/Way9Dexny3w?autoplay=1" },
        { t: "Interstellar", i: "https://upload.wikimedia.org/wikipedia/en/b/bc/Interstellar_film_poster.jpg", u: "https://www.youtube.com/embed/zSWdZVtXT7E?autoplay=1" },
        { t: "Blade Runner 2049", i: "https://upload.wikimedia.org/wikipedia/en/9/9b/Blade_Runner_2049_poster.png", u: "https://www.youtube.com/embed/gCcx85zbxz4?autoplay=1" }
    ],
    games: [
        { t: "Pac-Man", i: "https://upload.wikimedia.org/wikipedia/en/thumb/0/03/PacMan1980NA.jpg/220px-PacMan1980NA.jpg", u: "https://www.google.com/logos/2010/pacman10-i.html" },
        { t: "Space Invaders", i: "https://upload.wikimedia.org/wikipedia/en/thumb/5/52/Space_Invaders_arcade_flyer_%28Taito%29.jpg/220px-Space_Invaders_arcade_flyer_%28Taito%29.jpg", u: "https://freeinvaders.org/" },
        { t: "2048", i: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/2048_logo.svg/220px-2048_logo.svg.png", u: "https://play2048.co/" }
    ],
    products: [
        { t: "Chanel No.5", p: "$130", i: "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300" },
        { t: "Ray-Ban Aviator", p: "$180", i: "https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300" },
        { t: "Sony XM5", p: "$350", i: "https://images.unsplash.com/photo-1618366712010-f4ae9c647dcb?q=80&w=300" }
    ],
    chat: [
        { s: "in", m: "Welcome aboard, Mr. Guest. Dinner will be served in 40 minutes." }
    ]
};

// --- 2. SYSTEM CONTROLLER ---
const SYS = {
    data: {},
    
    init: function() {
        this.loadStorage();
        setTimeout(() => {
            document.getElementById('sys-boot').style.display = 'none';
            this.render();
            MAP.init();
            CHAT.render();
            this.startTime();
        }, 1500); // Fake boot time
    },

    loadStorage: function() {
        const u = localStorage.getItem('cx30_user');
        const v = localStorage.getItem('cx30_vis');
        const m = localStorage.getItem('cx30_mov');
        const g = localStorage.getItem('cx30_gam');

        this.data.user = u ? JSON.parse(u) : {...DB_FACTORY.user};
        this.data.vis = v ? JSON.parse(v) : {...DB_FACTORY.vis};
        this.data.movies = m ? JSON.parse(m) : [...DB_FACTORY.movies];
        this.data.games = g ? JSON.parse(g) : [...DB_FACTORY.games];
        this.data.products = [...DB_FACTORY.products];
        this.data.chat = [...DB_FACTORY.chat];
    },

    render: function() {
        const d = this.data;
        // Text Info
        document.getElementById('u-name').innerText = d.user.name;
        document.getElementById('h-seat').innerText = d.user.seat;
        document.getElementById('lock-seat').innerText = d.user.seat;
        document.getElementById('h-org').innerText = d.user.org;
        document.getElementById('h-dst').innerText = d.user.dst;
        document.getElementById('h-flt').innerText = d.user.flt;

        // Visuals
        document.getElementById('sb-logo').src = d.vis.logo;
        document.getElementById('lock-logo').src = d.vis.logo;
        document.getElementById('main-bg').style.backgroundImage = `url('${d.vis.bg}')`;

        // Entertainment Grids
        this.renderGrid('grid-mov', d.movies, 'MOVIE');
        this.renderGrid('grid-gam', d.games, 'GAME');
        
        // Shop Grid
        const sGrid = document.getElementById('grid-shop');
        sGrid.innerHTML = d.products.map(p => `
            <div class="card-media" style="height:300px; display:flex; flex-direction:column;">
                <div style="height:200px;"><img src="${p.i}" class="cm-img"></div>
                <div style="padding:15px;">
                    <div style="font-weight:bold;">${p.t}</div>
                    <div class="font-mono text-gold">${p.p}</div>
                    <button class="btn-action" style="padding:5px; margin-top:5px; font-size:10px;">BUY</button>
                </div>
            </div>
        `).join('');

        // Settings Inputs
        document.getElementById('set-name').value = d.user.name;
        document.getElementById('set-seat').value = d.user.seat;
        document.getElementById('set-org').value = d.user.org;
        document.getElementById('set-dst').value = d.user.dst;
        document.getElementById('set-flt').value = d.user.flt;
        document.getElementById('set-logo').value = d.vis.logo;
        document.getElementById('set-bg').value = d.vis.bg;
    },

    renderGrid: function(id, data, tag) {
        const el = document.getElementById(id);
        el.innerHTML = data.map(item => `
            <div class="card-media" onclick="PLAYER.open('${item.u}')">
                <img src="${item.i}" class="cm-img">
                <div class="cm-over">
                    <div class="font-head" style="font-size:14px; margin-bottom:2px;">${item.t}</div>
                </div>
                <div class="cm-tag">${tag}</div>
            </div>
        `).join('');
    },

    startTime: function() {
        setInterval(() => {
            const n = new Date();
            document.getElementById('sys-clock').innerText = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    },

    unlock: function() {
        document.getElementById('sys-lock').style.transform = "translateY(-100%)";
    }
};

// --- 3. NAVIGATION & TABS ---
const NAV = {
    go: function(pid, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(pid === 'p-home' || pid === 'p-map') MAP.init();
    }
};

const ENT = {
    tab: function(type) {
        document.querySelectorAll('.ent-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('.media-grid').forEach(g => g.classList.remove('show'));
        document.getElementById('grid-' + type).classList.add('show');
    }
};

// --- 4. PLAYER / VIEWER ---
const PLAYER = {
    open: function(url) {
        document.getElementById('viewer-frame').src = url;
        document.getElementById('sys-viewer').style.display = 'flex';
    },
    close: function() {
        document.getElementById('viewer-frame').src = '';
        document.getElementById('sys-viewer').style.display = 'none';
    }
};

// --- 5. CHAT SYSTEM ---
const CHAT = {
    render: function() {
        const box = document.getElementById('chat-box');
        box.innerHTML = SYS.data.chat.map(m => `
            <div class="chat-bubble ${m.s === 'in' ? 'cb-in' : 'cb-out'}">
                <span class="cb-meta">${m.s === 'in' ? 'Flight Crew' : 'Me'}</span>
                ${m.m}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    },
    send: function() {
        const inp = document.getElementById('chat-inp');
        const txt = inp.value.trim();
        if(!txt) return;

        SYS.data.chat.push({s: 'out', m: txt});
        this.render();
        inp.value = '';

        // Auto Reply Simulation
        setTimeout(() => {
            SYS.data.chat.push({s: 'in', m: "Received. A crew member is on their way."});
            this.render();
        }, 2000);
    }
};

// --- 6. CMS / SETTINGS MANAGER ---
const CMS = {
    saveId: function() {
        const u = SYS.data.user;
        u.name = document.getElementById('set-name').value;
        u.seat = document.getElementById('set-seat').value;
        u.org = document.getElementById('set-org').value.toUpperCase();
        u.dst = document.getElementById('set-dst').value.toUpperCase();
        u.flt = document.getElementById('set-flt').value.toUpperCase();
        localStorage.setItem('cx30_user', JSON.stringify(u));
        alert("Identity Updated");
        location.reload();
    },
    saveVis: function() {
        const v = SYS.data.vis;
        v.logo = document.getElementById('set-logo').value;
        v.bg = document.getElementById('set-bg').value;
        localStorage.setItem('cx30_vis', JSON.stringify(v));
        alert("Visuals Updated");
        location.reload();
    },
    addMedia: function() {
        const t = document.getElementById('add-mov-t').value;
        const i = document.getElementById('add-mov-i').value;
        const u = document.getElementById('add-mov-u').value;
        if(t && i && u) {
            SYS.data.movies.push({t, i, u});
            localStorage.setItem('cx30_mov', JSON.stringify(SYS.data.movies));
            alert("Movie/Video Added!");
            location.reload();
        }
    },
    addGame: function() {
        const t = document.getElementById('add-gam-t').value;
        const i = document.getElementById('add-gam-i').value;
        const u = document.getElementById('add-gam-u').value;
        if(t && i && u) {
            SYS.data.games.push({t, i, u});
            localStorage.setItem('cx30_gam', JSON.stringify(SYS.data.games));
            alert("Game Added to Arcade!");
            location.reload();
        }
    },
    reset: function() {
        if(confirm("Factory Reset System?")) {
            localStorage.clear();
            location.reload();
        }
    }
};

// --- 7. MAP CANVAS ENGINE ---
const MAP = {
    init: function() {
        ['mini-map', 'main-map'].forEach(id => {
            const c = document.getElementById(id);
            if(c) this.draw(c);
        });
    },
    draw: function(c) {
        const ctx = c.getContext('2d');
        const w = c.parentElement.clientWidth;
        const h = c.parentElement.clientHeight;
        c.width = w; c.height = h;

        // Space/Ocean
        ctx.fillStyle = '#050505';
        ctx.fillRect(0,0,w,h);

        // Grid
        ctx.strokeStyle = '#111';
        ctx.lineWidth = 1;
        for(let i=0; i<w; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
        for(let j=0; j<h; j+=40) { ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(w,j); ctx.stroke(); }

        // Path Logic
        const p1 = {x: w*0.1, y: h*0.6};
        const p2 = {x: w*0.9, y: h*0.4};
        const cp = {x: w*0.5, y: h*0.2};

        // Dashed Future Path
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.quadraticCurveTo(cp.x, cp.y, p2.x, p2.y);
        ctx.strokeStyle = '#333';
        ctx.setLineDash([6, 6]);
        ctx.stroke();

        // Active Path
        ctx.setLineDash([]);
        const t = 0.55; 
        const cx = (1-t)*(1-t)*p1.x + 2*(1-t)*t*cp.x + t*t*p2.x;
        const cy = (1-t)*(1-t)*p1.y + 2*(1-t)*t*cp.y + t*t*p2.y;
        
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.quadraticCurveTo(cp.x, cp.y, cx, cy);
        ctx.strokeStyle = '#006B6E';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Plane
        ctx.translate(cx, cy);
        ctx.fillStyle = '#C3A676';
        ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'rgba(195,166,118,0.4)';
        ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.stroke();
    }
};

window.onload = () => SYS.init();
</script>
</body>
</html>
